# MODELO CLASIFICACION ADABOOST

#Limpieza area de trabajo 
rm(list=ls())
cat('\014')

# cargar paquetes 
require("pacman")
# cargar librerias 
p_load(tidyverse, # Manipular dataframes
       rio, # Importar datos fácilmente
       plotly, # Gráficos interactivos
       leaflet, # Mapas interactivos
       units, # unidades
       sf, # Leer/escribir/manipular datos espaciales
       osmdata, # Obtener datos de OpenStreetMap (OSM)
       tidymodels, # Modelado de datos limpios y ordenados
       randomForest, # Modelos de bosque aleatorio
       rattle, # Interfaz gráfica para el modelado de datos
       spatialsample, # Muestreo espacial para modelos de aprendizaje automático
       xgboost,
       purrr,
       glmnet, 
       keras,
       themis,
       yardstick,
       tensorflow) 

#Creación de directorios
templates <- paste0(getwd(),'/templates/') # Directorio para crear templates

# cargar base de datos 
load(paste0(getwd(),'/predicting_poverty_bdmc','/stores/','base_completa.RData'))
bd <- base.completa 

# crear subset de testeo
test <- bd %>%
  subset(sample == "test")

## Crear un recipe para ambos modelos:
receta <- recipe(pobre ~ ., data = train) %>%
    step_normalize(all_numeric_predictors()) %>% # Normalizamos las variables numéricas

# Instalar y cargar el paquete adabag
if (!requireNamespace("adabag", quietly = TRUE)) {
  install.packages("adabag")
}

# Cargar adabag sin cargar rgl
library(adabag, exclude = c("rgl"))

install.packages("ROSE")
library(ROSE)

# Crear un conjunto de entrenamiento balanceado mediante SMOTE
set.seed(123)  # Fijar semilla para reproducibilidad
over_train_smote <- SMOTE(pobre ~ ., data = train, perc.over = 100, perc.under = 200)

# Crear un modelo Adaboost de clasificación
modelo_adaboost <- boosting(pobre ~ ., data = over_train_smote$dataset, boos = TRUE, mfinal = 200)

# Realizar predicciones en el conjunto de prueba
predicciones_adaboost <- predict(boosting, newdata = test, model = modelo_adaboost)

# Crear un dataframe con las predicciones
resultados_adaboost <- data.frame(id = test$id, pobre = as.numeric(predicciones_adaboost$class) - 1)

# Guardar el archivo CSV con las predicciones
write.csv(resultados_adaboost, file = paste0(templates, 'clasificacion_adaboost.csv'), row.names = FALSE)